#!/bin/bash
# ####
# Author <andy.pitcher@concordia.ca> Andy Pitcher 
# 
# This script correlates a given malware and perform a recursive search on the Apache access logs, by using the file timestamp (creation)
# Usage ./malware_access_correlation.sh /malware_path
#
##

scan_date_epoch=$(date --date="now" +"%s")
scan_date_real="$(date --date="@$scan_date_epoch" +"%d/%b/%Y:%H:%M:%S")"
quarantine_file="$1"
quarantine_file_hash="$(md5sum $quarantine_file | awk '{print $1}')"
quarantine_file_date_epoch="$(stat -c %Y $quarantine_file)"
quarantine_file_date_real="$(date --date="@$quarantine_file_date_epoch" +"%d/%b/%Y:%H:%M:%S")"

#Get time window (days) between scan and file timestamp
diff_time_window=$(( ( $scan_date_epoch - $quarantine_file_date_epoch )/(60*60*24) ))
#Increase time window for better fault timestamp tolerance (+5days)
mtime_window=$(($diff_time_window +5))

#Research variables

quarantine_file_timewindow="$(date --date="@$quarantine_file_date_epoch" +"%d/%b/%Y:%H:%M")"
Apache_log_path='/var/log/apache2'
echo "Scan date: $scan_date_real\n"
echo "Info for $quarantine_file"
echo "Hash(md5): $quarantine_file_hash"
echo "Epoch time: $quarantine_file_date_epoch"
echo "Apache time: $quarantine_file_date_real"
echo "Search time window (mtime): $diff_time_window days ($mtime_window days used)\n"

echo "---------------"
echo "Ongoing test: find $Apache_log_path -mtime -$mtime_window -type f -name "*log*" -exec zgrep -B2 -A2 -i $quarantine_file_date_real {} +"
echo "\nMatched Apache access logs:\n---------"

search=$(find $Apache_log_path -mtime -$mtime_window -type f -name "*log*" -exec zgrep -B2 -A2 -i $quarantine_file_timewindow {} + )

if [ ! -z "$search" ]; then
    echo  "$search\n\nDone"
#    exit 0 
else
    echo  "Nothing found, try to increase the time window\nDone"
    exit 1
fi
