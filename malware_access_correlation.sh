#!/bin/bash
# 
# Author Andy Pitcher 
# 
#This script correlates a given injected and caught malware by nails in /quarantine
#with the Apache access logs.
#
#Usage ./malware_access_correlation.sh /quarantine/example.file
scan_date_epoch=$(date --date="now" +"%s")
scan_date_real="$(date --date="@$scan_date_epoch" +"%d/%b/%Y:%H:%M:%S")"
quarantine_file="$1"
quarantine_file_hash="$(md5sum $quarantine_file | awk '{print $1}')"
quarantine_file_date_epoch="$(stat -c %Y $quarantine_file)"
quarantine_file_date_real="$(date --date="@$quarantine_file_date_epoch" +"%d/%b/%Y:%H:%M:%S")"

#Get time window (days) between scan and file timestamp
diff_time_window=$(( ( $scan_date_epoch - $quarantine_file_date_epoch )/(60*60*24) ))
#Increase time window for better fault timestamp tolerance (+5days)
mtime_window=$(($diff_time_window +5))

#Research variables

quarantine_file_timewindow="$(date --date="@$quarantine_file_date_epoch" +"%d/%b/%Y:%H:%M")"
Apache_log_path='/home/logs/apache'
echo -e "Scan date: $scan_date_real\n"
echo -e "Info for $quarantine_file"
echo -e "Hash(md5): $quarantine_file_hash"
echo -e "Epoch time: $quarantine_file_date_epoch"
echo  -e "Apache time: $quarantine_file_date_real"
echo -e "Search time window (mtime): $diff_time_window days ($mtime_window days used)\n"

echo -e "---------------"
echo -e "Ongoing test: find $Apache_log_path -mtime -$mtime_window -type f -name "*log*" -exec zgrep -i $quarantine_file_date_real {} +"
echo -e "\nMatched Apache access logs:\n\n"

search=$(find $Apache_log_path -mtime -$mtime_window -type f -name "*log*" -exec zgrep -i $quarantine_file_timewindow {} +)

if [ ! -z "$search" ]; then
    echo -e "$search\n\nDone"
#    exit 1 
else
    echo -e "Nothing found, try to increase the time window\nDone"
fi
